# Деплой на сервер

## Разработка (локально)

Запуск с автоматическим перезапуском при изменении кода:

```bash
npm run dev
```

Сервер перезапустится при изменении `server.js` и файлов в `src/`. После `git pull` на сервере используйте `docker compose up -d --build` для пересборки и перезапуска.

## Требования

- Docker и Docker Compose на сервере
- Файл `.env` с настройками (см. ниже)

## Первый запуск

1. Скопировать проект на сервер (например, `git clone`).

2. Создать `.env` в корне проекта:
   ```bash
   cp .env.example .env
   ```
   Заполнить переменные:
   - `PORT` — порт приложения (по умолчанию 3000)
   - `TELEGRAM_BOT_TOKEN` — токен бота от @BotFather
   - `TELEGRAM_CHAT_ID` — ID чата для уведомлений

3. Запустить:
   ```bash
   docker compose up -d
   ```

## Обычный запуск (две команды)

Когда проект уже на сервере и `.env` создан:

```bash
cd /path/to/pavel-maria
docker compose up -d
```

Или одной строкой:
```bash
cd /path/to/pavel-maria && docker compose up -d
```

Приложение будет:
- работать в фоне;
- перезапускаться при падении;
- перезапускаться после перезагрузки сервера.

## Полезные команды

| Действие | Команда |
|----------|---------|
| Запуск | `docker compose up -d` |
| Запуск после изменений кода | `docker compose up -d --build` |
| Просмотр логов | `docker compose logs -f` |
| Остановка | `docker compose down` |
| Перезапуск | `docker compose restart` |

## Порт

По умолчанию приложение доступно на порту 3000. Порт маппится из `.env` автоматически. Для доступа по домену через порт 80 (без :3040 в URL) в `docker-compose.yml`:

```yaml
ports:
  - "80:${PORT:-3000}"
```

Тогда в `.env` задайте нужный порт приложения, а снаружи будет доступ на 80.

## Не открывается сайт из браузера

1. **Проверьте firewall на сервере** (если используется):
   ```bash
   sudo ufw allow 3040    # или 80, если используете порт 80
   sudo ufw reload
   sudo ufw status
   ```

2. **Проверьте, что порт слушается**:
   ```bash
   sudo ss -tlnp | grep 3040
   # или
   sudo netstat -tlnp | grep 3040
   ```

3. **DNS домена** — A-запись `weddandreevs.ru` должна указывать на `193.227.241.214`.

4. **Тест с сервера**:
   ```bash
   curl http://localhost:3040
   ```
   Если отвечает — приложение работает, проблема в firewall или доступе извне.

5. **Порт 80 для домена** — чтобы заходить по `http://weddandreevs.ru` без порта, в `docker-compose.yml` замените секцию `ports`:
   ```yaml
   ports:
     - "80:3040"
   ```
   Тогда приложение слушает 3040 внутри контейнера, а снаружи доступно на 80.
