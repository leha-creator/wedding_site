# Docker build fails: better-sqlite3 native module requires Python and build tools

**Date:** 2026-02-22 01:32
**Files:** Dockerfile
**Severity:** high

## Problem

`docker build` fails at `RUN npm ci --omit=dev`:

- `prebuild-install` times out (no prebuilt binary downloaded)
- `node-gyp rebuild` fails: "Could not find any Python installation to use"
- `better-sqlite3` is a native addon — it must be compiled for the target platform

Error occurs in `node:20-slim` where Python, make, and g++ are not installed.

## Root Cause

`node:20-slim` is a minimal image. It has Node.js but not:
- Python (required by node-gyp)
- make, g++ (required to compile C++ addons)

`better-sqlite3` uses `prebuild-install` first (download prebuilt binary). When that times out, it falls back to `node-gyp rebuild`, which requires the build toolchain. Without it, the build fails.

## Solution

Multi-stage Docker build:

1. **Builder stage:** Use `node:20-slim` + install `python3`, `make`, `g++`
2. Run `npm ci --omit=dev` — node-gyp compiles better-sqlite3
3. **Runtime stage:** Use `node:20-slim` again, copy only compiled `node_modules` from builder
4. No build tools in final image — smaller and more secure

## Prevention

- For native Node modules (better-sqlite3, bcrypt, etc.) in Docker: use multi-stage build with build deps in builder stage
- Alternative: switch to pure-JS equivalents (e.g. sql.js for SQLite) — no compilation, but different API
- Document in Dockerfile why build stage exists (comment)

## Tags

`#docker` `#native-module` `#better-sqlite3` `#node-gyp` `#multi-stage-build`
